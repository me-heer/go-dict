<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
	<title>Dictionary</title>
	<link rel="stylesheet" href="/static/style.css">
	<script src="https://unpkg.com/htmx.org@1.9.10"></script>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="color-scheme" content="light dark">
</head>

<body>
	<main class="container" id="main-container">
		<div class="search-section">
			<form hx-post="/search" hx-target="#results" hx-indicator="#loading"
				hx-trigger="submit, keyup[keyCode==13]" class="search-form">
				<div class="search-container">
					<svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
						stroke="currentColor" stroke-width="2">
						<circle cx="11" cy="11" r="8"></circle>
						<path d="m21 21-4.35-4.35"></path>
					</svg>
					<input type="text" name="word" placeholder="Search for a word..." autofocus
						required>
				</div>
			</form>

			<div id="loading" class="htmx-indicator loading">
				Searching...
			</div>
		</div>

		{{if .History}}
		<div class="vocabulary-section">
			<button id="vocabulary-toggle" class="vocabulary-toggle">
				<span>Your Vocabulary</span>
				<svg class="toggle-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
					stroke="currentColor" stroke-width="2">
					<polyline points="6 9 12 15 18 9"></polyline>
				</svg>
			</button>
			<div id="vocabulary-list" class="vocabulary-list hidden">
				<div class="history-list">
					{{range .History}}
					<button class="history-item" onclick="searchWord('{{.}}')">{{.}}</button>
					{{end}}
				</div>
				<button class="clear-history-btn" hx-post="/history" hx-target="#history-container"
					hx-swap="innerHTML">
					Clear All
				</button>
			</div>
		</div>
		{{end}}

		<div id="results">
			<!-- Results will be loaded here -->
		</div>
	</main>

	<script>
		// Ensure the input is focused when the page loads
		document.addEventListener('DOMContentLoaded', function () {
			const wordInput = document.querySelector('input[name="word"]');
			if (wordInput) {
				wordInput.focus();
			}

			// Set up vocabulary toggle
			const toggleBtn = document.getElementById('vocabulary-toggle');
			const vocabularyList = document.getElementById('vocabulary-list');

			if (toggleBtn && vocabularyList) {
				toggleBtn.addEventListener('click', function () {
					vocabularyList.classList.toggle('hidden');
					toggleBtn.classList.toggle('active');
				});
			}
		});

		// Handle layout changes when results are shown
		document.body.addEventListener('htmx:afterRequest', function (event) {
			const container = document.getElementById('main-container');
			const results = document.getElementById('results');
			const wordInput = document.querySelector('input[name="word"]');

			if (event.detail.xhr.status === 200) {
				// Check if results contain content
				if (results && results.innerHTML.trim()) {
					container.classList.add('has-results');

					// Update history immediately
					updateHistory();
				}

				// Re-focus the input immediately
				if (wordInput) {
					wordInput.focus();
				}
			}
		});

		// Function to search a word from history
		function searchWord(word) {
			const wordInput = document.querySelector('input[name="word"]');
			if (wordInput) {
				wordInput.value = word;
				// Trigger the form submission immediately
				const form = wordInput.closest('form');
				if (form) {
					htmx.trigger(form, 'submit');
				}
			}
		}

		// Function to update history display
		function updateHistory() {
			fetch('/history')
				.then(response => response.text())
				.then(html => {
					const vocabularySection = document.querySelector('.vocabulary-section');
					if (vocabularySection) {
						const parser = new DOMParser();
						const doc = parser.parseFromString(html, 'text/html');
						const newVocabularySection = doc.querySelector('.vocabulary-section');
						if (newVocabularySection) {
							vocabularySection.innerHTML = newVocabularySection.innerHTML;

							// Re-attach event listener to toggle button
							const toggleBtn = document.getElementById('vocabulary-toggle');
							const vocabularyList = document.getElementById('vocabulary-list');

							if (toggleBtn && vocabularyList) {
								toggleBtn.addEventListener('click', function () {
									vocabularyList.classList.toggle('hidden');
									toggleBtn.classList.toggle('active');
								});
							}
						}
					} else {
						// If no vocabulary section exists, add it
						const searchSection = document.querySelector('.search-section');
						const parser = new DOMParser();
						const doc = parser.parseFromString(html, 'text/html');
						const newVocabularySection = doc.querySelector('.vocabulary-section');
						if (newVocabularySection && searchSection) {
							searchSection.insertAdjacentElement('afterend', newVocabularySection);

							// Attach event listener to toggle button
							const toggleBtn = document.getElementById('vocabulary-toggle');
							const vocabularyList = document.getElementById('vocabulary-list');

							if (toggleBtn && vocabularyList) {
								toggleBtn.addEventListener('click', function () {
									vocabularyList.classList.toggle('hidden');
									toggleBtn.classList.toggle('active');
								});
							}
						}
					}
				});
		}

		// Add keyboard shortcut to toggle vocabulary list
		document.addEventListener('keydown', function (event) {
			// Alt+V to toggle vocabulary list
			if (event.altKey && event.key === 'v') {
				const toggleBtn = document.getElementById('vocabulary-toggle');
				if (toggleBtn) {
					toggleBtn.click();
				}
			}
		});
	</script>
</body>

</html>
